name: Build iOS No-Sign

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Install Dependencies
        run: flutter pub get

      - name: üõ†Ô∏è Hack Xcode Project (Disable Signing)
        run: |
          echo "üî• Hacking project.pbxproj..."
          PBX="ios/Runner.xcodeproj/project.pbxproj"
          
          # –£–¥–∞–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –∏ –ø—Ä–æ–≤–∏–∂–Ω –ø—Ä–æ—Ñ–∏–ª–µ–π
          sed -i '' '/DevelopmentTeam/d' $PBX
          sed -i '' '/ProvisioningStyle/d' $PBX
          sed -i '' '/CODE_SIGN_IDENTITY/d' $PBX
          sed -i '' '/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]"/d' $PBX
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º Manual –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –ø–æ–¥–ø–∏—Å—å
          sed -i '' 's/CODE_SIGN_STYLE = .*/CODE_SIGN_STYLE = Manual;/g' $PBX
          
          # –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä—è–º–æ –≤ –∫–æ–Ω—Ñ–∏–≥ Flutter (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥)
          CONFIG="ios/Flutter/Release.xcconfig"
          echo "" >> $CONFIG
          echo "CODE_SIGNING_REQUIRED=NO" >> $CONFIG
          echo "CODE_SIGNING_ALLOWED=NO" >> $CONFIG
          echo "CODE_SIGN_STYLE=Manual" >> $CONFIG
          echo "CODE_SIGN_IDENTITY=" >> $CONFIG
          echo "DEVELOPMENT_TEAM=" >> $CONFIG
          echo "PROVISIONING_PROFILE_SPECIFIER=" >> $CONFIG
          
          echo "‚úÖ Project hacked successfully!"

      - name: üèóÔ∏è Build iOS App (Release)
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏
          flutter build ios --release --no-codesign
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É Payload –∏ –∫–ª–∞–¥–µ–º —Ç—É–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Ä—É—á–Ω–∞—è —Å–±–æ—Ä–∫–∞ IPA)
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          
          # –°–∂–∏–º–∞–µ–º –≤ .ipa
          zip -r Runner.ipa Payload

      - name: üì§ Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: smart-grow-box-ipa
          path: Runner.ipa
