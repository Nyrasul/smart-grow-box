name: Force Build iOS

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build_with_xcodebuild:
    runs-on: macos-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      
      - name: üì¶ Install Dependencies
        run: |
          flutter pub get
          cd ios
          pod install --repo-update
          cd ..

      - name: üî® Force Build (Bypass Flutter Tool)
        run: |
          echo "üöÄ Starting raw xcodebuild..."
          cd ios
          
          # –£–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è –≤—ã–≤–æ–¥–∞ (build_output), —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞—Ç—å –ø–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build_output \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build
            
      - name: üì¶ Package IPA
        run: |
          echo "üì¶ Packaging..."
          mkdir Payload
          
          # –¢–µ–ø–µ—Ä—å –º—ã —Ç–æ—á–Ω–æ –∑–Ω–∞–µ–º, –≥–¥–µ –ª–µ–∂–∏—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          APP_PATH="ios/build_output/Build/Products/Release-iphoneos/Runner.app"
          
          if [ -d "$APP_PATH" ]; then
            echo "‚úÖ App found at: $APP_PATH"
            cp -r "$APP_PATH" Payload/
            zip -r smart-grow-box.ipa Payload
          else
            echo "‚ùå Error: Runner.app not found at expected path!"
            echo "üîç Listing build directory for debugging:"
            find ios/build_output -maxdepth 4
            exit 1
          fi

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: smart-grow-box-ipa
          path: smart-grow-box.ipa
