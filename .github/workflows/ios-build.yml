name: Force Build iOS

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build_with_xcodebuild:
    runs-on: macos-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      
      - name: üì¶ Install Dependencies
        run: |
          flutter pub get
          cd ios
          pod install --repo-update
          cd ..

      - name: üî® Force Build (Bypass Flutter Tool)
        run: |
          echo "üöÄ Starting raw xcodebuild..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É iOS
          cd ios
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ xcodebuild.
          # –≠—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç Flutter –≤–Ω—É—Ç—Ä–∏ Xcode, –Ω–æ –æ–±—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏ —Å–∞–º–æ–≥–æ Flutter.
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build
            
      - name: üì¶ Package IPA
        run: |
          # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è IPA
          mkdir Payload
          
          # –ò—â–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø—É—Ç—å –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è, –∏—â–µ–º —á–µ—Ä–µ–∑ find)
          APP_PATH=$(find ios/build/Release-iphoneos -name "Runner.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Error: Runner.app not found!"
            exit 1
          fi
          
          echo "‚úÖ Found app at: $APP_PATH"
          cp -r "$APP_PATH" Payload/
          
          # –°–∂–∏–º–∞–µ–º
          zip -r smart-grow-box.ipa Payload

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: smart-grow-box-ipa
          path: smart-grow-box.ipa
